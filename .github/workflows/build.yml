name: Build OpenWrt x86_64 10G

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 1800

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup packages
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk gettext unzip \
            file wget rsync subversion python3-distutils python3-setuptools

      - name: Copy custom config (from repo/config/.config)
        run: |
          if [ -f config/.config ]; then
            cp config/.config ./.config
            echo "Custom .config copied"
            echo "---- .config ----"
            sed -n '1,200p' ./.config || true
          else
            echo "No custom .config found"
          fi

      - name: Setup feeds & community packages
        run: |
          # Ensure package/community exists
          mkdir -p package/community
          # Clone common third-party packages (use shallow clones)
          git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall-packages.git package/community/passwall-packages || true
          git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall.git package/community/passwall || true
          git clone --depth 1 https://github.com/fw876/helloworld.git package/community/helloworld || true
          git clone --depth 1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/community/adguard || true
          git clone --depth 1 https://github.com/pymumu/smartdns.git package/community/smartdns || true

      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply defconfig
        run: |
          make defconfig -j$(nproc)

      - name: Build (this may take long)
        run: |
          make -j$(nproc) V=s || (echo "Build failed, printing last 200 lines of logs"; tail -n 200 logs/* || true; exit 1)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-x86_64-artifacts
          path: bin/targets/x86/64/
